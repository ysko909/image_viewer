# 要件定義書

## 目的

`app/static/img` ディレクトリに保存されている画像ファイルの一覧をWebページに表示し、各画像をクリックすると専用のページで大きく表示する。さらに、画像表示ページからスライドショーを開始できるようにする。

## 機能

- `/images` のようなURLにアクセスすると、画像ファイル一覧ページが表示される。
- ページには、`app/static/img` ディレクトリ内のすべての画像ファイル名がリスト形式で表示される。
- 各ファイル名は、画像表示ページへのリンクとする。
- `/image/<filename>` のようなURLにアクセスすると、指定された画像ファイルが表示されるページが表示される。
- 画像表示ページにスライドショーを開始するボタンを追加する。
- スライドショー機能:
    - １ファイルにつき設定された時間表示し、一定時間経過後は次の画像ファイルを表示する。
    - スライドショーの表示時間は設定ページから変更可能とする。
    - 最後のファイルを表示し終わったら、一覧表示に戻る。
    - 表示順はファイル名順にとする。ただし、将来的に「表示順のシャッフル機能」を追加したいため、拡張性を確保した仕様とする。

## 想定ユーザー

- アプリケーションの管理者または開発者

# 設計書

## 概略設計

- Flaskアプリケーションに `/images` ルートと `/image/<filename>` ルート、そしてスライドショー用の新しいルートを追加する。
- `/images` ルートでは、`app/static/img` ディレクトリの内容を読み取り、ファイル名のリストを取得する。
- `/images` ルートは、取得したファイル名のリストを `image_list.html` テンプレートに渡し、画像表示ページへのリンクを含む一覧を生成する。
- `/image/<filename>` ルートでは、指定されたファイル名を `image_display.html` テンプレートに渡し、画像を表示する。
- スライドショー用の新しいルートでは、画像ファイルのリストを取得し、JavaScriptを使用して設定された時間ごとに画像を切り替える処理を行う。表示順序の制御はバックエンドで行い、シャッフル機能のための拡張性を考慮する。
- スライドショーの表示時間を設定するための新しいルートとテンプレートを追加する。

## 機能設計

### ルート `/images`

- HTTPメソッド: GET
- 処理内容:
    1. `app/static/img` ディレクトリのパスを取得する。
    2. 指定されたディレクトリ内のファイル一覧を取得する。
    3. 取得したファイル一覧から、画像ファイル（例: `.png`, `.jpg`, `.jpeg`, `.gif`, `.webp` などの拡張子を持つファイル）をフィルタリングする。
    4. フィルタリングされたファイル名のリストを `image_list.html` テンプレートに渡してレンダリングする。
- レスポンス: 画像ファイル一覧を表示するHTMLページ

### ルート `/image/<filename>`

- HTTPメソッド: GET
- パラメータ: `<filename>` (表示する画像ファイル名)
- 処理内容:
    1. パラメータとして受け取ったファイル名を `image_display.html` テンプレートに渡し、画像を表示する。
    2. スライドショー開始ボタンのリンク先として、スライドショー用のルートに画像ファイル名のリストを渡す準備をする。
- レスポンス: 指定された画像ファイルを表示するHTMLページ

### ルート `/slideshow/<filename>` (新規)

- HTTPメソッド: GET
- パラメータ: `<filename>` (スライドショーを開始する画像ファイル名)
- 処理内容:
    1. `app/static/img` ディレクトリ内の画像ファイル一覧を取得し、ファイル名順にソートする。
    2. パラメータで指定されたファイル名からスライドショーを開始するための、ファイルリスト内での開始位置を特定する。
    3. 画像ファイルリストと開始位置をテンプレートに渡す。
- レスポンス: スライドショーを表示するHTMLページ

### ルート `/slideshow/config` (新規)

- HTTPメソッド: GET
- 処理内容:
    1. 現在のスライドショー表示時間を設定から取得する。
    2. 取得した表示時間を `slideshow_config.html` テンプレートに渡してレンダリングする。
- レスポンス: スライドショー設定ページを表示するHTMLページ

### ルート `/slideshow/config/save` (新規)

- HTTPメソッド: POST
- 処理内容:
    1. POSTデータから表示時間（ミリ秒）を取得する。
    2. 入力値が有効な数値であることを確認する。
    3. 入力値が最小値（例: 500ミリ秒）以上であることを確認する。
    4. 有効な場合は、アプリケーションの設定としてスライドショー表示時間を保存する。
    5. 設定ページにリダイレクトする。
- レスポンス: スライドショー設定ページへのリダイレクト

### テンプレート `image_list.html`

- ベーステンプレート: `layout.html` を継承する。
- 表示内容:
    - ページタイトル: "画像ファイル一覧"
    - `app/static/img` ディレクトリ内の画像ファイル名をリスト (`<ul>` または `<ol>`) で表示する。
    - 各リスト項目 (`<li>`) は、ファイル名と、画像表示ページへのリンク (`<a>`) を含む。リンクのURLは `/image/<ファイル名>` とする。

### テンプレート `image_display.html`

- ベーステンプレート: `layout.html` を継承する。
- 表示内容:
    - ページタイトル: "画像表示"
    - 指定された画像ファイル (`<img>` タグを使用) を表示する。画像のURLは `/static/img/<ファイル名>` とする。
    - 一覧ページに戻るためのリンク (`<a>`) を含む。
    - スライドショーを開始するためのボタンまたはリンクを追加する。このリンクは `/slideshow/<現在のファイル名>` の形式とする。

### テンプレート `slideshow.html` (新規)

- ベーステンプレート: `layout.html` を継承する。
- 表示内容:
    - ページタイトル: "スライドショー"
    - 現在表示している画像ファイル (`<img>` タグを使用) を表示する領域。
    - JavaScriptを使用して、一定時間ごとに表示する画像を切り替える。
    - 画像の切り替え順序は、バックエンドから渡されたファイルリストに従う。
    - 最後の画像が表示されたら、JavaScriptで一覧表示ページ (`/images`) にリダイレクトする。

### テンプレート `slideshow_config.html` (新規)

- ベーステンプレート: `layout.html` を継承する。
- 表示内容:
    - ページタイトル: "スライドショー設定"
    - スライドショーの表示時間（ミリ秒）を入力するためのフォーム。
    - 現在の設定値がフォームの初期値として表示される。
    - 設定を保存するための送信ボタン。

## クラス構成

既存の `app.py` に新しいルート関数を追加する。新しいクラスは不要。

- `app.py`:
    - `index()` 関数 (既存)
    - `image_list()` 関数 (修正): `/images` ルートに対応し、画像ファイル一覧を取得して `image_list.html` をレンダリングする。リンク先を `/image/<filename>` に変更。
    - `image_display()` 関数 (修正): `/image/<filename>` ルートに対応し、指定された画像を表示するために `image_display.html` をレンダリングする。スライドショー開始ボタンのリンクを追加。
    - `slideshow()` 関数 (修正): `/slideshow/<filename>` ルートに対応し、画像ファイルリストを取得・ソートし、アプリケーション設定からスライドショー表示時間を取得して `slideshow.html` をレンダリングする。
    - `slideshow_config()` 関数 (新規): `/slideshow/config` ルートに対応し、現在のスライドショー表示時間を取得して `slideshow_config.html` をレンダリングする。
    - `save_slideshow_config()` 関数 (新規): `/slideshow/config/save` ルートに対応し、POSTデータから表示時間を取得してアプリケーション設定に保存し、設定ページにリダイレクトする。

## ディレクトリ構成

```
/app
├── app.py
├── static/
│   └── img/
│       ├── code_smartphone_qrcode.png
│       ├── kanban_closed.gif
│       └── seiza_fuyu_daisankaku.webp
├── templates/
│   ├── index.html
│   ├── image_display.html (修正)
│   ├── image_list.html (修正)
│   ├── layout.html
│   ├── slideshow.html (修正)
│   └── slideshow_config.html (新規作成)
└── docs/
    └── design.md (更新)
```

## テスト計画

- `tests/test_app.py` にテストコードを作成/更新する。
- `/images` ルートへのGETリクエストが成功することを確認するテスト。
- `/images` ページのHTMLに、画像ファイル名と `/image/<filename>` 形式のリンクが含まれていることを確認するテスト。
- `/image/<filename>` ルートへのGETリクエストが成功することを確認するテスト。
- `/image/<filename>` ページのHTMLに、指定した画像ファイルが表示される `<img>` タグとスライドショー開始リンクが含まれていることを確認するテスト。
- `/slideshow/<filename>` ルートへのGETリクエストが成功することを確認するテスト。
- `/slideshow/<filename>` ページのHTMLに、画像表示領域と、バックエンドから渡された表示時間データが含まれていることを確認するテスト。
- `/slideshow/config` ルートへのGETリクエストが成功することを確認するテスト。
- `/slideshow/config` ページのHTMLに、表示時間設定フォームと現在の設定値が含まれていることを確認するテスト。
- `/slideshow/config/save` ルートへのPOSTリクエストが成功し、設定が更新されることを確認するテスト。
- スライドショーのJavaScriptが正しく動作し、設定された表示時間で画像が切り替わること（これは単体テストでは難しいが、結合テストや手動テストで確認）
- 最後の画像表示後に一覧ページに戻るJavaScriptの動作確認（結合テストや手動テストで確認）
- ファイル名順での表示（テストでファイルリストの順序を確認）